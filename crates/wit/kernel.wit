package trovato:kernel;

/// Item API — handle-based field access across the WASM boundary.
/// Plugins receive an opaque s32 handle and call host functions to
/// read/write individual fields, avoiding bulk serialization.
interface item-api {
    // Read
    get-title: func(item-handle: s32) -> string;
    get-field-string: func(item-handle: s32, field-name: string) -> option<string>;
    get-field-int: func(item-handle: s32, field-name: string) -> option<s64>;
    get-field-float: func(item-handle: s32, field-name: string) -> option<f64>;
    get-field-json: func(item-handle: s32, field-name: string) -> option<string>;
    get-type: func(item-handle: s32) -> string;
    get-id: func(item-handle: s32) -> string;
    get-revision-id: func(item-handle: s32) -> string;
    get-author-id: func(item-handle: s32) -> string;
    get-status: func(item-handle: s32) -> s32;
    get-created: func(item-handle: s32) -> s64;
    get-changed: func(item-handle: s32) -> s64;

    // Write
    set-title: func(item-handle: s32, value: string);
    set-field-string: func(item-handle: s32, field-name: string, value: string);
    set-field-int: func(item-handle: s32, field-name: string, value: s64);
    set-field-float: func(item-handle: s32, field-name: string, value: f64);
    set-field-json: func(item-handle: s32, field-name: string, value-json: string);
    set-status: func(item-handle: s32, value: s32);
}

/// Structured database API — prevents SQL injection from plugins.
interface db {
    select: func(query-json: string) -> result<string, string>;
    insert: func(table: string, data-json: string) -> result<string, string>;
    update: func(table: string, data-json: string, where-json: string) -> result<u64, string>;
    delete: func(table: string, where-json: string) -> result<u64, string>;
    query-raw: func(sql: string, params-json: string) -> result<string, string>;
    execute-raw: func(sql: string, params-json: string) -> result<u64, string>;
}

/// Persistent key-value configuration.
interface variables {
    get: func(name: string, default-value: string) -> string;
    set: func(name: string, value: string) -> result<_, string>;
}

/// Per-request shared state (key-value).
interface request-context {
    get: func(key: string) -> option<string>;
    set: func(key: string, value: string);
}

/// User and permission checks.
interface user-api {
    current-user-has-permission: func(permission: string) -> bool;
    current-user-id: func() -> string;
}

/// Cache operations with tag-based invalidation.
interface cache-api {
    get: func(bin: string, key: string) -> option<string>;
    set: func(bin: string, key: string, value: string, tags-json: string);
    invalidate-tag: func(tag: string);
}

/// Inter-plugin communication.
interface plugin-api {
    invoke: func(plugin-name: string, function-name: string, payload: string)
        -> result<string, string>;
    plugin-exists: func(plugin-name: string) -> bool;
}

/// Structured logging.
interface logging {
    log: func(level: string, plugin: string, message: string);
}

/// The plugin world — all imports and exports for a Trovato plugin.
world plugin {
    import item-api;
    import db;
    import variables;
    import request-context;
    import user-api;
    import cache-api;
    import plugin-api;
    import logging;

    // Lifecycle
    export tap-install: func() -> result<_, string>;
    export tap-enable: func() -> result<_, string>;
    export tap-disable: func() -> result<_, string>;
    export tap-uninstall: func() -> result<_, string>;

    // Content type registration
    export tap-item-info: func() -> string;

    // Item CRUD — handle-based (default)
    export tap-item-view: func(item-handle: s32) -> string;
    export tap-item-view-alter: func(render-json: string, item-handle: s32) -> string;
    export tap-item-insert: func(item-handle: s32) -> result<_, string>;
    export tap-item-update: func(item-handle: s32) -> result<_, string>;
    export tap-item-delete: func(item-id: string) -> result<_, string>;
    export tap-item-access: func(item-handle: s32, op: string) -> string;

    // Item CRUD — full-serialization (opt-in)
    export tap-item-view-full: func(item-json: string) -> string;
    export tap-item-insert-full: func(item-json: string) -> result<_, string>;
    export tap-item-update-full: func(item-json: string) -> result<_, string>;

    // Categories
    export tap-categories-term-insert: func(term-json: string) -> result<_, string>;
    export tap-categories-term-update: func(term-json: string) -> result<_, string>;
    export tap-categories-term-delete: func(term-id: string) -> result<_, string>;

    // Forms
    export tap-form-alter: func(form-id: string, form-json: string) -> string;
    export tap-form-validate: func(form-id: string, values-json: string) -> string;
    export tap-form-submit: func(form-id: string, values-json: string) -> result<_, string>;

    // Routing & permissions
    export tap-menu: func() -> string;
    export tap-perm: func() -> string;

    // Theme
    export tap-theme: func() -> string;
    export tap-preprocess-item: func(context-json: string, item-handle: s32) -> string;

    // Search
    export tap-item-update-index: func(item-handle: s32) -> string;

    // Cron & queues
    export tap-cron: func() -> result<_, string>;
    export tap-queue-info: func() -> string;
    export tap-queue-worker: func(item-json: string) -> result<_, string>;

    // User lifecycle
    export tap-user-login: func(user-json: string) -> result<_, string>;
}
