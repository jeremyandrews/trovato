{% extends "page--admin.html" %}

{% block content %}
<div class="admin-header">
    <h2>Manage fields: {{ content_type.label }}</h2>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/admin/structure/types/{{ content_type.machine_name }}/fields/add" class="button button--primary">Add field</a>
        <a href="/admin/structure/types/{{ content_type.machine_name }}/edit" class="button button--secondary">Edit content type</a>
    </div>
</div>

<div class="admin-card" id="fields-wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>Label</th>
                <th>Machine name</th>
                <th>Field type</th>
                <th>Required</th>
                <th>Operations</th>
            </tr>
        </thead>
        <tbody id="fields-tbody">
            <tr>
                <td><strong>Title</strong></td>
                <td><code>title</code></td>
                <td>Text</td>
                <td>Yes</td>
                <td>-</td>
            </tr>
            {% for field in fields %}
            <tr data-field="{{ field.field_name }}">
                <td>{{ field.label }}</td>
                <td><code>{{ field.field_name }}</code></td>
                <td>{{ field.field_type }}</td>
                <td>{% if field.required %}Yes{% else %}No{% endif %}</td>
                <td>
                    <a href="/admin/structure/types/{{ content_type.machine_name }}/fields/{{ field.field_name }}/edit">Edit</a>
                    &middot;
                    <a href="/admin/structure/types/{{ content_type.machine_name }}/fields/{{ field.field_name }}/delete"
                       onclick="return confirm('Are you sure you want to delete this field?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not fields %}
    <p id="no-fields-message">No custom fields defined yet.</p>
    {% endif %}
</div>

<div class="admin-card" style="margin-top: 1rem;">
    <h3 style="margin-top: 0;">Add a new field</h3>
    <form method="post" action="/admin/structure/types/{{ content_type.machine_name }}/fields/add" id="add-field-form">
        <input type="hidden" name="_token" value="{{ csrf_token }}">
        <input type="hidden" name="_form_build_id" value="{{ form_build_id }}">

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <div class="form-item" style="flex: 1; min-width: 200px;">
                <label for="new_field_label" class="form-item__label form-item__label--required">Label</label>
                <input type="text" id="new_field_label" name="label" class="form-text" required>
            </div>

            <div class="form-item" style="flex: 1; min-width: 200px;">
                <label for="new_field_name" class="form-item__label form-item__label--required">Machine name</label>
                <input type="text" id="new_field_name" name="name" class="form-text"
                       pattern="[a-z][a-z0-9_]*" required>
            </div>

            <div class="form-item" style="flex: 1; min-width: 200px;">
                <label for="new_field_type" class="form-item__label form-item__label--required">Type</label>
                <select id="new_field_type" name="field_type" class="form-select" required>
                    <option value="">- Select -</option>
                    <option value="text">Text (plain)</option>
                    <option value="text_long">Text (long)</option>
                    <option value="integer">Integer</option>
                    <option value="float">Float</option>
                    <option value="boolean">Boolean</option>
                    <option value="date">Date</option>
                    <option value="email">Email</option>
                    <option value="record_reference">Reference</option>
                </select>
            </div>

            <div class="form-item" style="display: flex; align-items: flex-end;">
                <button type="submit" class="button button--primary"
                        data-ajax-trigger="add_field"
                        data-ajax-wrapper="#fields-wrapper">
                    Add field
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Auto-generate machine name from label
document.getElementById('new_field_label').addEventListener('input', function(e) {
    const machineNameInput = document.getElementById('new_field_name');
    if (!machineNameInput.dataset.userEdited) {
        machineNameInput.value = 'field_' + e.target.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '')
            .substring(0, 26);
    }
});

document.getElementById('new_field_name').addEventListener('input', function() {
    this.dataset.userEdited = 'true';
});
</script>
{% endblock %}
