{% extends "page--admin.html" %}
{% import "admin/macros/list.html" as list %}

{% block content %}
{{ list::header(title="Comments") }}

<div class="admin-card">
    <form class="filter-form" method="get" action="/admin/content/comments">
        <div class="filter-row">
            <div class="filter-item">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">- Any -</option>
                    <option value="1" {% if status_filter == "1" %}selected{% endif %}>Published</option>
                    <option value="0" {% if status_filter == "0" %}selected{% endif %}>Pending</option>
                </select>
            </div>
            <div class="filter-item">
                <button type="submit" class="button button--secondary">Filter</button>
            </div>
        </div>
    </form>
</div>

<div class="admin-card">
    {% if comments %}
    <table class="table">
        <thead>
            <tr>
                <th>Comment</th>
                <th>Author</th>
                <th>Content</th>
                <th>Status</th>
                <th>Posted</th>
                <th>Operations</th>
            </tr>
        </thead>
        <tbody>
            {% for comment in comments %}
            <tr>
                <td class="comment-body">
                    <div class="comment-preview">{{ comment.body | truncate(length=100) }}</div>
                    {% if comment.depth > 0 %}
                    <span class="comment-reply-indicator">Reply (depth {{ comment.depth }})</span>
                    {% endif %}
                </td>
                <td>{{ authors[comment.author_id] | default(value="Unknown") }}</td>
                <td>
                    {% if items[comment.item_id] %}
                    <a href="/admin/content/{{ comment.item_id }}/edit">{{ items[comment.item_id] }}</a>
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                </td>
                <td>
                    {% if comment.status == 1 %}
                    <span class="status status--published">Published</span>
                    {% else %}
                    <span class="status status--pending">Pending</span>
                    {% endif %}
                </td>
                <td>{{ comment.created | date(format="%Y-%m-%d %H:%M") }}</td>
                <td class="operations">
                    {% if comment.status == 0 %}
                    <form method="post" action="/admin/content/comments/{{ comment.id }}/approve" style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <button type="submit" class="link-button">Approve</button>
                    </form>
                    &middot;
                    {% else %}
                    <form method="post" action="/admin/content/comments/{{ comment.id }}/unpublish" style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <button type="submit" class="link-button">Unpublish</button>
                    </form>
                    &middot;
                    {% endif %}
                    <a href="/admin/content/comments/{{ comment.id }}/edit">Edit</a>
                    &middot;
                    {{ list::delete_button(action="/admin/content/comments/" ~ comment.id ~ "/delete", confirm_text="Are you sure you want to delete this comment?", btn_class="link-button link-button--danger", csrf_token=csrf_token) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total > comments | length %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="button button--secondary">&laquo; Previous</a>
        {% endif %}
        <span class="pagination-info">Page {{ page }} of {{ (total / per_page) | round(method="ceil") | int }}</span>
        {% if comments | length == per_page %}
        <a href="?page={{ page + 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="button button--secondary">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <p>No comments found.</p>
    {% endif %}
</div>

<style>
    .filter-form {
        margin-bottom: 0;
    }
    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }
    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    .filter-item label {
        font-size: 0.875rem;
        font-weight: 500;
    }
    .filter-item select {
        padding: 0.375rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 0.25rem;
    }
    .comment-body {
        max-width: 300px;
    }
    .comment-preview {
        font-size: 0.875rem;
        color: var(--gray-700);
    }
    .comment-reply-indicator {
        display: inline-block;
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }
    .status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    .status--published {
        background: #d4edda;
        color: #155724;
    }
    .status--pending {
        background: #fff3cd;
        color: #856404;
    }
    .operations {
        white-space: nowrap;
    }
    .text-muted {
        color: var(--gray-500);
    }
    .pagination {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }
    .pagination-info {
        color: var(--gray-600);
        font-size: 0.875rem;
    }
</style>
{% endblock %}
